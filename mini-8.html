<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MiniMachineVM</title>
  <style>
    body { font-family: monospace; background: #111; color: #0f0; padding: 20px; }
    input, button { margin: 10px 0; }
    pre { background: #000; padding: 10px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>MiniMachineVM</h1>
  <input type="file" id="fileInput" />
  <button onclick="runVM()">Run</button>
  <label>
    <input type="checkbox" id="stepMode" />
        Debug mode
    </label>
    <button id="stepBtn" onclick="stepVM()" disabled>Step</button>
    <h2>Output</h2>
    <pre id="output"></pre>
    <h2>Registers</h2>
    <pre id="registers" style="margin-top:1em;"></pre>
    <h2>Disassembly</h2>
    <pre id="disasm" style="margin-top:1em;"></pre>
  <script>
    let programBytes = null;

    document.getElementById("fileInput").addEventListener("change", function (event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const arrayBuffer = e.target.result;
        programBytes = new Uint8Array(arrayBuffer);
        printOutput("Program loaded. Ready to run.\n");
      };
      reader.readAsArrayBuffer(file);
    });
    document.getElementById("stepMode").addEventListener("change", function (event) {
        document.getElementById("stepBtn").disabled = !event.target.checked;
    });

    function printOutput(str) {
      const output = document.getElementById("output");
      output.textContent += str;
    }

    function clearOutput() {
      document.getElementById("output").textContent = "";
    }

function runVM() {
  if (!programBytes) {
    alert("Please load a program file first.");
    return;
  }
  vm = new MiniMachineVM(programBytes); // Make vm global for stepping
  clearOutput();
  if (document.getElementById("stepMode").checked) {
    printOutput("Debug mode enabled. Click 'Step' to execute instructions.\n");
    document.getElementById("stepBtn").disabled = false;
    document.getElementById("registers").style.display = "";
    document.getElementById("disasm").style.display = "";
    vm.renderRegisters();
  } else {
    document.getElementById("registers").style.display = "none";
    document.getElementById("disasm").style.display = "none";
    vm.run();
  }
}

function stepVM() {
  if (!vm || vm.halted) {
    printOutput("\n[Program Halted]\n");
    return;
  }
  vm.step();
  vm.renderRegisters();
  if (vm.halted) {
    printOutput("\n[Program Halted]\n");
  }
}
    class MiniMachineVM {
      constructor(program) {
        this.reg = new Array(8).fill(0); // r0-r7
        this.ram = new Array(256).fill(0);
        this.stack = [];
        this.program = program;
        this.halted = false;
        this.PC = 7; // r7 is PC
      }

      fetch() {
        const pc = this.reg[this.PC];
        const idx = pc * 4;
        if (idx + 4 > this.program.length) {
          this.halted = true;
          return null;
        }
        return this.program.slice(idx, idx + 4);
      }

      getOperand(val, isImm) {
        return isImm ? val : this.reg[val & 0x7];
      }

      setReg(idx, value) {
        if (idx === 6) return; // r6 is reserved
        this.reg[idx] = value & 0xFF;
      }

      wrt(val, fmt) {
        let ch = "";
        switch (fmt) {
          case 0:
            ch = val === 0 ? "\n" : String.fromCharCode(val);
            break;
          case 1:
            ch = val <= 9 ? val.toString() : "?";
            break;
          case 2:
            ch = val <= 25 ? String.fromCharCode(65 + val) : "?";
            break;
          case 3:
            ch = val <= 15 ? val.toString(16).toUpperCase() : "?";
            break;
        }
        printOutput(ch);
      }

      execute(instr) {
        const [opcode, op1, op2, dest] = instr;
        const imm1 = (opcode >> 6) & 1;
        const imm2 = (opcode >> 5) & 1;
        const opclass = (opcode >> 3) & 0x3;
        const subtype = opcode & 0x7;

        // ALU
        if (opclass === 0b00) {
          let a = this.getOperand(op1, imm1);
          let b = this.getOperand(op2, imm2);
          let res = 0;
          switch (subtype) {
            case 0: res = a & b; break;
            case 1: res = ((a >>> (b % 8)) | (a << (8 - (b % 8)))) & 0xFF; break;
            case 2: res = (a + b) & 0xFF; break;
            case 3: res = a ^ b; break;
            case 4: res = a | b; break;
            case 5: res = ((a << (b % 8)) | (a >>> (8 - (b % 8)))) & 0xFF; break;
            case 6: res = (a - b) & 0xFF; break;
            case 7: res = (~a) & 0xFF; break;
          }
          this.setReg(dest & 0x7, res);
          this.reg[this.PC] = (this.reg[this.PC] + 1) % 256;
          return;
        }

        // COND
        if (opclass === 0b01) {
          let jump = false;
          let a = this.getOperand(op1, imm1);
          let b = this.getOperand(op2, imm2);
          switch (subtype) {
            case 0: jump = true; break;
            case 1: jump = a !== b; break;
            case 2: jump = a >= b; break;
            case 3: jump = a > b; break;
            case 4: jump = false; break;
            case 5: jump = a === b; break;
            case 6: jump = a < b; break;
            case 7: jump = a <= b; break;
          }
          if (jump) {
            this.setReg(this.PC, dest);
          } else {
            this.reg[this.PC] = (this.reg[this.PC] + 1) % 256;
          }
          return;
        }

        // IO
        if (opclass === 0b10) {
          switch (subtype) {
            case 0: {
              const val = this.getOperand(op1, imm1);
              this.setReg(dest & 0x7, val);
              break;
            }
            case 1: {
              const idx1 = op1 & 0x7;
              const idx2 = dest & 0x7;
              if (idx1 !== 6 && idx2 !== 6) {
                [this.reg[idx1], this.reg[idx2]] = [this.reg[idx2], this.reg[idx1]];
              }
              break;
            }
            case 2: {
              const val = this.getOperand(op1, imm1);
              this.stack.push(val);
              break;
            }
            case 3: {
              if (this.stack.length > 0) {
                this.setReg(dest & 0x7, this.stack.pop());
              }
              break;
            }
            case 4: {
              const val = this.getOperand(op1, imm1);
              const fmt = op2 & 0x3;
              this.wrt(val, fmt);
              break;
            }
            case 5: {
              const addr = this.getOperand(op1, imm1);
              this.stack.push(this.reg[this.PC]);
              this.setReg(this.PC, addr);
              return;
            }
            case 6: {
              let offset = this.reg[0];
              if (offset >= 0x80) offset -= 0x100;
              this.setReg(this.PC, (this.reg[this.PC] + offset) & 0xFF);
              return;
            }
            case 7: {
              this.halted = true;
              return;
            }
          }
          this.reg[this.PC] = (this.reg[this.PC] + 1) % 256;
        }
      }
renderRegisters() {
  const names = ["r0", "r1", "r2", "r3", "r4", "r5", "r6", "PC"];
  let out = names.map((n, i) => `${n}: ${this.reg[i].toString(16).padStart(2, "0")}`).join("  ");
  document.getElementById("registers").textContent = out;
}


        run() {
        while (!this.halted) {
            const instr = this.fetch();
            if (!instr) break;
            this.execute(instr);
        }
        printOutput("\n[Program Halted]\n");
        }

        step() {
        if (this.halted) return;
        const instr = this.fetch();
        if (!instr) {
            this.halted = true;
            return;
        }
        this.execute(instr);
        }
    }
  </script>
</body>
</html>
